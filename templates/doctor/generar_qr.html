{% extends "base.html" %}

{% block title %}Generar Nuevo QR{% endblock %}

{% block head %}
{{ super() }}
<style>
    /*
    * Variables de color (tomadas de tu style.css)
    */
    :root {
        --color-primary-red: #D32F2F;
        --color-secondary-emphasis: #F98F1D;
        --color-card-bg: #FFFFFF;
        --color-shadow-light: rgba(0, 0, 0, 0.08);
        --color-text-dark: #2C3E50;
        --color-text-faded: #7F8C8D;
        --color-border-light: #DCE1E7;
        --color-primary-red-dark: #A52A2A;
        --color-white: #FFFFFF;
        --color-disabled-bg: #EAECEE;
    }

    /* --- Estilo de la Tarjeta Contenedora --- */
    .form-container.card {
        max-width: 100%;
        padding: 40px;
        margin-bottom: 30px;
        background-color: var(--color-card-bg);
        border-radius: 8px;
        box-shadow: 0 4px 12px var(--color-shadow-light);
        border-left: 5px solid var(--color-secondary-emphasis);
    }

    /* --- Estilo de Cuadrícula (Dos Columnas) --- */
    .form-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px 25px;
        margin-bottom: 30px;
    }

    /* --- Estilos para los campos de formulario dentro del contenedor --- */
    .form-container label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: var(--color-text-dark);
        text-align: left;
        font-size: 1.05em;
    }

    .form-container input,
    .form-container select,
    .form-container textarea {
        width: 100%;
        padding: 12px 15px;
        margin-bottom: 0;
        border: 1px solid var(--color-border-light);
        border-radius: 8px;
        font-size: 1rem;
        color: var(--color-text-dark);
        background-color: var(--color-card-bg);
        transition: border-color 0.3s, box-shadow 0.3s;
        box-sizing: border-box;
    }

    /* Estilo para los selectores/inputs de solo lectura */
    .form-container input[readonly],
    .form-container select:disabled,
    .form-container input:disabled {
        background-color: var(--color-disabled-bg);
        cursor: not-allowed;
        color: var(--color-text-faded);
    }

    .form-container input:focus,
    .form-container select:focus,
    .form-container textarea:focus {
        border-color: var(--color-primary-red);
        box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.2);
        outline: none;
    }

    /* --- Botón --- */
    .btn-primary.btn-full-width {
        width: 100%;
        margin-top: 15px;
        padding: 15px;
        background-color: var(--color-primary-red);
        color: var(--color-white);
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: background-color 0.3s;
        text-transform: uppercase;
    }

    .btn-primary.btn-full-width:hover {
        background-color: var(--color-primary-red-dark);
    }

    /* Estilo para el botón deshabilitado */
    .btn-primary.btn-full-width:disabled {
        background-color: #6C7A89; /* Color de fondo para indicar que está deshabilitado */
        cursor: not-allowed;
    }

    .description-text {
        margin-bottom: 25px;
        line-height: 1.6;
        color: var(--color-text-faded);
    }

    /* Estilo para el enlace de "Volver" */
    .back-link {
        display: block;
        margin-top: 30px;
        text-align: center;
        color: var(--color-text-faded);
        text-decoration: none;
        transition: color 0.3s;
    }

    .back-link:hover {
        color: var(--color-primary-red);
    }

    /* --- Media Query para volver a 1 columna en móviles --- */
    @media (max-width: 768px) {
        .form-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .form-container.card {
            padding: 20px;
        }
    }
</style>
{% endblock %}

{# OPCIONAL: Personaliza el encabezado superior del panel #}
{% block top_header_content %}
<h3 class="top-header-title">Generar Nuevo Código QR</h3>
<p class="top-header-subtitle">Gestión de campañas de autoprueba.</p>
{% endblock %}

{% block content %}

<div class="form-container card">
    <p class="description-text">
        Ingrese los detalles de la campaña y la cantidad de códigos QR que desea generar. Los códigos **se registrarán y
        estarán disponibles para descarga en la tabla del Dashboard**.
    </p>

    <form method="POST">

        <div class="form-grid">

            <div class="grid-item">
                <label for="campaign_number">1. Número de Campaña:</label>
                <input type="text" id="campaign_number" name="campaign_number" required
                    placeholder="Ej: Campaña 1" value="{{ data.campaign_number | default('') }}">
            </div>

            <div class="grid-item">
                <label for="delivery_date">2. Fecha de Entrega (Prevista):</label>
                {# Establecer readonly si se ha cargado una campaña existente en JS #}
                <input type="date" id="delivery_date" name="delivery_date" required placeholder="AAAA-MM-DD"
                    value="{{ data.delivery_date | default(today) }}">
            </div>

            <div class="grid-item">
                <label for="quantity">3. Cantidad de Códigos QR a Generar:</label>
                <input type="number" id="quantity" name="quantity" required min="1"
                    value="{{ data.quantity | default(1) }}">
            </div>

            {# --- Campos de Ubicación (Cargados COMPLETAMENTE por Jinja) --- #}

            <div class="grid-item">
                <label for="estado">4. Estado:</label>
                {# El estado será deshabilitado si se carga una campaña existente en JS #}
                <select id="estado" name="estado" required>
                    <option value="" disabled selected>Seleccione un Estado</option>
                    {# Carga de todos los estados #}
                    {% for estado in estados %}
                    <option value="{{ estado.id }}">{{ estado.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="grid-item">
                <label for="municipio">5. Municipio:</label>
                {# El municipio será deshabilitado si se carga una campaña existente en JS #}
                <select id="municipio" name="municipio" required>
                    <option value="" disabled selected>Seleccione un Municipio</option>
                    {# Carga de todos los municipios (¡NO en cascada!) #}
                    {% for municipio in municipios %}
                    <option data-estado="{{municipio.estado}}" value="{{ municipio.id }}">{{ municipio.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="grid-item">
                <label for="colonia">6. Colonia:</label>
                {# La colonia será deshabilitada si se carga una campaña existente en JS #}
                <select id="colonia" name="colonia" required>
                    <option value="" disabled selected>Seleccione una Colonia</option>
                    {# Carga de todas las colonias (¡NO en cascada!), incluyendo el CP como atributo #}
                    {% for colonia in colonias %}
                    <option data-municipio="{{colonia.municipio}}" value="{{ colonia.id }}"
                        data-cp="{{ colonia.codigo_postal }}">
                        {{ colonia.nombre }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="grid-item">
                <label for="codigo_postal">7. Código Postal:</label>
                {# CAMBIO CRÍTICO: Usamos readonly en lugar de disabled para que el valor se envíe en el POST #}
                <input type="text" id="codigo_postal" name="codigo_postal" readonly
                    placeholder="Se auto-genera al seleccionar colonia" value="">
            </div>

        </div>

        <button type="submit" class="btn-primary btn-full-width btn-submit">
            GENERAR QRS
        </button>
    </form>

    <a href="{{ url_for('doctor_bp.dashboard') }}" class="back-link">
        &larr; Volver al Panel de Control
    </a>
</div>

{% endblock %}


{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const campaignNumberInput = document.getElementById('campaign_number');
        const deliveryDateInput = document.getElementById('delivery_date');
        const quantityInput = document.getElementById('quantity');
        const estadoSelect = document.getElementById('estado');
        const municipioSelect = document.getElementById('municipio');
        const coloniaSelect = document.getElementById('colonia');
        const cpInput = document.getElementById('codigo_postal');
        const submitButton = document.querySelector('.btn-submit'); // Seleccionamos el botón

        // VALORES POR DEFECTO Y OPCIONES
        const todayDate = '{{ today }}'; 
        const todosMunicipios = Array.from(municipioSelect.options);
        const todasColonias = Array.from(coloniaSelect.options);
        const defaultMunicipioOption = todosMunicipios.find(opt => opt.value === "");
        const defaultColoniaOption = todasColonias.find(opt => opt.value === "");

        // --- FUNCIONES DE MANEJO DEL FORMULARIO ---

        /** Restablece los selects de ubicación al estado "Seleccione un..." y limpia el CP. */
        function resetLocationSelects() {
            municipioSelect.innerHTML = "";
            municipioSelect.appendChild(defaultMunicipioOption.cloneNode(true));
            municipioSelect.value = ""; 

            coloniaSelect.innerHTML = "";
            coloniaSelect.appendChild(defaultColoniaOption.cloneNode(true));
            coloniaSelect.value = ""; 

            estadoSelect.value = ""; 
            
            cpInput.value = "";
            cpInput.placeholder = "Se auto-genera al seleccionar colonia";

            // Asegura que los campos de ubicación estén editables
            estadoSelect.disabled = false;
            municipioSelect.disabled = false;
            coloniaSelect.disabled = false;
        }

        /** Restablece los campos principales (Fecha y Cantidad) a valores por defecto. */
        function clearPrimaryFields() {
            // Restablecemos la fecha al valor del Jinja ({{ today }})
            deliveryDateInput.value = todayDate;
            quantityInput.value = '1';
            deliveryDateInput.readOnly = false; // Asegura que la fecha sea editable
        }

        // --- LÓGICA DE FILTRADO DE UBICACIÓN (CASCADA) ---

        function filtrarMunicipiosPorIdEstado(idEstado) {
            return todosMunicipios.filter(opcion => 
                opcion.value === "" || opcion.dataset.estado == idEstado
            );
        }
        
        function filtrarColoniasPorIdMunicipio(idMunicipio) {
            return todasColonias.filter(opcion => 
                opcion.value === "" || opcion.dataset.municipio == idMunicipio
            );
        }

        /** Rellena un select con opciones filtradas y selecciona un valor si se proporciona. */
        function populateSelect(selectElement, filteredOptions, selectedValue = null) {
            selectElement.innerHTML = "";
            
            filteredOptions.forEach(opcion => {
                selectElement.appendChild(opcion.cloneNode(true));
            });
            
            if (selectedValue) {
                selectElement.value = String(selectedValue);
            } else {
                selectElement.value = ""; 
            }
        }
        
        /** Actualiza el select de Colonia y el input de Código Postal. */
        function updateColoniaAndCP(idMunicipio, idColonia = null, cpValueFromDB = null) {
            const coloniasFiltradas = filtrarColoniasPorIdMunicipio(idMunicipio);
            
            populateSelect(coloniaSelect, coloniasFiltradas, idColonia);

            let finalCP = '';
            if (cpValueFromDB) {
                finalCP = cpValueFromDB;
            } else if (idColonia && coloniaSelect.value) {
                const selectedOption = coloniaSelect.options[coloniaSelect.selectedIndex];
                finalCP = selectedOption ? selectedOption.getAttribute('data-cp') : '';
            } 
            
            cpInput.value = finalCP || '';
            cpInput.placeholder = finalCP || 'Se auto-genera al seleccionar colonia';
        }

        // Eventos de usuario para el filtrado en cascada
        estadoSelect.addEventListener('change', (e) => {
            if (estadoSelect.disabled) return;
            const idEstadoSeleccionado = e.target.value;
            const municipiosFiltrados = filtrarMunicipiosPorIdEstado(idEstadoSeleccionado);
            
            populateSelect(municipioSelect, municipiosFiltrados);
            updateColoniaAndCP(""); 
        });

        municipioSelect.addEventListener('change', (e) => {
            if (municipioSelect.disabled) return;
            const idMunicipioSeleccionado = e.target.value;
            updateColoniaAndCP(idMunicipioSeleccionado);
        });
        
        coloniaSelect.addEventListener('change', (event) => {
            if (coloniaSelect.disabled) return;
            const selectedOption = event.target.options[event.target.selectedIndex];
            const cpValue = selectedOption.value === "" ? '' : selectedOption.getAttribute('data-cp') || '';

            cpInput.value = cpValue;
            cpInput.placeholder = cpValue || 'Se auto-genera al seleccionar colonia';
        });

        
        // LÓGICA DE CONSULTA Y RELLENO DE CAMPAÑA 
        

        campaignNumberInput.addEventListener('change', () => {
            const campaignNumber = campaignNumberInput.value.trim();

            if (campaignNumber.length > 0) {
                const url = `{{ url_for('doctor_bp.consultar_campana', numero_campana='DUMMY') }}`.replace('DUMMY', campaignNumber);
                
                // Deshabilitar el botón mientras se consulta
                submitButton.disabled = true;
                submitButton.textContent = 'CONSULTANDO CAMPAÑA...';

                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                             throw new Error('Error de red al consultar la campaña');
                        }
                        return response.json();
                    })
                    .then(result => {
                        if (result.exists && result.data) {
                            const data = result.data;
                            
                            // 1. Rellenar Fecha de Entrega y forzar ReadOnly
                            // Si la fecha existe en la DB, debe estar en formato YYYY-MM-DD
                            deliveryDateInput.value = data.fecha_entrega; 
                            deliveryDateInput.readOnly = true;
                            
                            // 2. Rellenar Estado y deshabilitar
                            estadoSelect.value = data.id_estado;
                            estadoSelect.disabled = true;
                            
                            // 3. Filtrar, rellenar Municipio y deshabilitar
                            const municipiosFiltrados = filtrarMunicipiosPorIdEstado(data.id_estado);
                            populateSelect(municipioSelect, municipiosFiltrados, data.id_municipio);
                            municipioSelect.disabled = true;

                            // 4. Filtrar, rellenar Colonia y CP, y deshabilitar
                            updateColoniaAndCP(data.id_municipio, data.id_colonia, data.codigo_postal);
                            coloniaSelect.disabled = true;

                            // 5. Deshabilitar botón y mostrar estado de la campaña (MOSTRAR CONTEO DE QRS)
                            submitButton.disabled = true;
                            // La cantidad de QRs existentes se muestra aquí:
                            submitButton.textContent = `CAMPAÑA EXISTENTE (${data.qrs_existentes} QRs GENERADOS) - NO SE PUEDE CREAR DE NUEVO.`; 
                            
                            // NOTA: quantityInput se mantiene editable para generar QRs adicionales.

                        } else {
                            // Campaña no encontrada: Restablecer todos los campos y habilitar el botón
                            clearPrimaryFields(); 
                            resetLocationSelects(); // Esto habilita los selects de ubicación

                            submitButton.disabled = false;
                            submitButton.textContent = 'GENERAR QRS';
                        }
                    })
                    .catch(error => {
                        console.error('Error al consultar la campaña:', error);
                        alert("Hubo un error al buscar la campaña. Intente de nuevo. Se habilitó el botón.");
                        
                        // Si hay un error, dejamos el formulario editable por si fue un error de red
                        clearPrimaryFields();
                        resetLocationSelects();

                        submitButton.disabled = false;
                        submitButton.textContent = 'GENERAR QRS'; 
                    });
            } else {
                // Si el campo de campaña se deja vacío, restablecer campos
                clearPrimaryFields();
                resetLocationSelects();
                submitButton.disabled = false;
                submitButton.textContent = 'GENERAR QRS';
            }
        });
        
        // --- INICIALIZACIÓN (Asegurando la precarga de fecha/cantidad) ---
        
        // Verificar si hay datos de estado precargados (indica un POST fallido)
        const hasPreloadedData = '{{ data.estado | default("") }}' !== '';

        if (!hasPreloadedData) {
            // Si no hay datos precargados, inicializa limpiamente (muestra los selects de ubicación vacíos)
            resetLocationSelects();
        } else {
            // Si hay datos precargados (POST fallido), re-selecciona y rellena los campos principales

            const idEstadoPrecargado = '{{ data.estado | default("") }}';
            const idMunicipioPrecargado = '{{ data.municipio | default("") }}';
            const idColoniaPrecargada = '{{ data.colonia | default("") }}';
            const cpPrecargado = '{{ data.codigo_postal | default("") }}';

            if (idEstadoPrecargado) {
                // Rellenar campos principales (estos vienen del formulario POST que falló)
                deliveryDateInput.value = '{{ data.delivery_date | default(today) }}'; // Rellena fecha
                quantityInput.value = '{{ data.quantity | default(1) }}'; // Rellena cantidad

                // Rellenar ubicaciones en cascada
                estadoSelect.value = idEstadoPrecargado;
                
                const municipiosFiltrados = filtrarMunicipiosPorIdEstado(idEstadoPrecargado);
                populateSelect(municipioSelect, municipiosFiltrados, idMunicipioPrecargado);
                
                if (idMunicipioPrecargado) {
                    updateColoniaAndCP(idMunicipioPrecargado, idColoniaPrecargada, cpPrecargado);
                }
            }
        }
    });
</script>
{% endblock %}